#!/bin/bash
# è·¨å¹³å°å¯åŠ¨è„šæœ¬
# è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶è°ƒç”¨ç›¸åº”çš„å¯åŠ¨è„šæœ¬

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å‡½æ•°ï¼šæ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
print_success() { echo -e "${GREEN}âœ… $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
print_error() { echo -e "${RED}âŒ $1${NC}"; }

# å‡½æ•°ï¼šæ£€æµ‹æ“ä½œç³»ç»Ÿ
detect_os() {
    print_info "æ£€æµ‹æ“ä½œç³»ç»Ÿ..."
    
    case "$(uname -s)" in
        Linux*)
            OS="Linux"
            print_success "æ“ä½œç³»ç»Ÿ: Linux"
            ;;
        Darwin*)
            OS="macOS"
            print_success "æ“ä½œç³»ç»Ÿ: macOS"
            ;;
        CYGWIN*|MINGW*|MSYS*)
            OS="Windows"
            print_success "æ“ä½œç³»ç»Ÿ: Windows"
            ;;
        *)
            OS="Unknown"
            print_warning "æ“ä½œç³»ç»Ÿ: æœªçŸ¥ ($(uname -s))"
            ;;
    esac
    
    export OS
}

# å‡½æ•°ï¼šæ˜¾ç¤ºè·¨å¹³å°å¸®åŠ©
show_cross_platform_help() {
    echo "é¢˜åº“ç³»ç»Ÿè·¨å¹³å°å¯åŠ¨è„šæœ¬"
    echo "ç”¨æ³•: ./run [å‘½ä»¤] [é€‰é¡¹]"
    echo ""
    echo "å‘½ä»¤:"
    echo "  start        å¯åŠ¨æ‰€æœ‰æœåŠ¡"
    echo "  web          åªå¯åŠ¨WebæœåŠ¡"
    echo "  wechat       åªå¯åŠ¨å¾®ä¿¡APIæœåŠ¡"
    echo "  mcp          åªå¯åŠ¨MCPæœåŠ¡"
    echo "  status       æ˜¾ç¤ºæœåŠ¡çŠ¶æ€"
    echo "  stop         åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo "  restart      é‡å¯æ‰€æœ‰æœåŠ¡"
    echo "  setup        å®‰è£…ä¾èµ–å’Œåˆå§‹åŒ–"
    echo "  help         æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "é€‰é¡¹:"
    echo "  --system     ä½¿ç”¨ç³»ç»ŸPythonå®‰è£…ä¾èµ–ï¼ˆLinux/macOSï¼‰"
    echo ""
    echo "å¹³å°ç‰¹å®šè„šæœ¬:"
    echo "  Linux/macOS:  ./run.sh [å‘½ä»¤]"
    echo "  Windows:      ./scripts/windows/run.ps1 [å‘½ä»¤]"
    echo "                ./scripts/windows/run.bat"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  ./run start              # è‡ªåŠ¨é€‰æ‹©å¹³å°è„šæœ¬"
    echo "  ./run.sh start           # Linux/macOSä¸“ç”¨"
    echo "  ./scripts/windows/run.ps1 start  # Windowsä¸“ç”¨"
    echo ""
    echo "è®¿é—®åœ°å€:"
    echo "  Webç®¡ç†ç•Œé¢: http://localhost:8000"
    echo "  APIæ–‡æ¡£:     http://localhost:8000/docs"
    echo "  å¾®ä¿¡API:     http://localhost:8001"
    echo "  MCPæ¥å£:     http://localhost:8002"
}

# å‡½æ•°ï¼šLinux/macOSå¯åŠ¨
start_linux_macos() {
    print_info "ä½¿ç”¨Linux/macOSå¯åŠ¨è„šæœ¬..."
    
    if [[ ! -f "run.sh" ]]; then
        print_error "æœªæ‰¾åˆ°Linux/macOSå¯åŠ¨è„šæœ¬: run.sh"
        exit 1
    fi
    
    # ä¼ é€’æ‰€æœ‰å‚æ•°ç»™run.sh
    ./run.sh "$@"
}

# å‡½æ•°ï¼šWindowså¯åŠ¨
start_windows() {
    print_info "ä½¿ç”¨Windowså¯åŠ¨è„šæœ¬..."
    
    # æ£€æŸ¥PowerShellè„šæœ¬
    if [[ -f "scripts/windows/run.ps1" ]]; then
        print_info "ä½¿ç”¨PowerShellè„šæœ¬..."
        echo ""
        echo "Windowsç”¨æˆ·è¯·æ‰§è¡Œ:"
        echo "  .\scripts\windows\run.ps1 $*"
        echo ""
        echo "æˆ–åŒå‡»è¿è¡Œ: scripts\windows\run.bat"
        echo ""
        print_info "æ³¨æ„: Windowsè„šæœ¬éœ€è¦PowerShellæ‰§è¡Œæƒé™"
        echo "è®¾ç½®æ‰§è¡Œæƒé™: Set-ExecutionPolicy RemoteSigned -Scope CurrentUser"
    elif [[ -f "scripts/windows/run.bat" ]]; then
        print_info "ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬..."
        echo ""
        echo "Windowsç”¨æˆ·è¯·æ‰§è¡Œ:"
        echo "  scripts\windows\run.bat"
        echo "æˆ–åŒå‡»è¿è¡Œè¯¥æ–‡ä»¶"
    else
        print_error "æœªæ‰¾åˆ°Windowså¯åŠ¨è„šæœ¬"
        echo "è¯·æ£€æŸ¥ scripts/windows/ ç›®å½•"
        exit 1
    fi
}

# ä¸»ç¨‹åº
main() {
    print_info "ğŸš€ é¢˜åº“ç³»ç»Ÿè·¨å¹³å°å¯åŠ¨è„šæœ¬"
    echo "è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶é€‰æ‹©æœ€ä½³å¯åŠ¨æ–¹å¼"
    echo ""
    
    # æ£€æµ‹æ“ä½œç³»ç»Ÿ
    detect_os
    
    # è§£æå‘½ä»¤
    COMMAND="${1:-help}"
    
    case "$COMMAND" in
        "help"|"-h"|"--help")
            show_cross_platform_help
            ;;
        *)
            # æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å¯åŠ¨æ–¹å¼
            case "$OS" in
                "Linux"|"macOS")
                    start_linux_macos "$@"
                    ;;
                "Windows")
                    start_windows "$@"
                    ;;
                *)
                    print_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS"
                    echo ""
                    echo "è¯·æ‰‹åŠ¨é€‰æ‹©å¯åŠ¨è„šæœ¬:"
                    echo "  Linux/macOS: ./run.sh [å‘½ä»¤]"
                    echo "  Windows:     ./scripts/windows/run.ps1 [å‘½ä»¤]"
                    exit 1
                    ;;
            esac
            ;;
    esac
}

# è¿è¡Œä¸»ç¨‹åº
main "$@"