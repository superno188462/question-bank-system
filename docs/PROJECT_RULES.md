# 题库系统项目规则

## 🎯 项目概述
题库管理系统，采用"独立前端，共享核心"的多前端架构，支持：
1. 🌐 **Web入口** - 完整的Web管理界面（端口8000）
2. 📱 **微信小程序入口** - 移动端刷题API（端口8002）
3. 🤖 **MCP入口** - AI集成接口（端口8001）

## 🏗️ 架构规则（必须遵守）

### 核心架构原则
**遵循AGENTS.md全局规则中的"多前端架构规则"**

### 目录结构规则
```
question-bank-system/
├── web/           # 🌐 Web入口（必须独立）
├── wechat/        # 📱 微信小程序入口（必须独立）
├── mcp/           # 🤖 MCP入口（必须独立）
├── core/          # ⚙️ 共享核心层（必须共享）
├── shared/        # 🔧 共享工具和配置
├── scripts/       # 📜 部署和工具脚本
├── docs/          # 📚 项目文档
├── deployments/   # 🚀 部署配置
└── tests/         # 🧪 测试代码
```

### 1. 前端独立规则
#### Web入口 (`web/`)
- **目录要求**：必须独立，不依赖其他前端代码
- **启动方式**：`python start.py web`
- **端口**：8000（可配置）
- **功能范围**：完整的题目管理功能

#### 微信入口 (`wechat/`)
- **目录要求**：必须独立，专门为移动端优化
- **启动方式**：`python start.py wechat`
- **端口**：8002（可配置）
- **功能范围**：移动端刷题、微信登录

#### MCP入口 (`mcp/`)
- **目录要求**：必须独立，实现MCP协议
- **启动方式**：`python start.py mcp`
- **端口**：8001（可配置）
- **功能范围**：AI工具集成、自然语言交互

### 2. 核心共享规则
#### 业务逻辑共享 (`core/services.py`)
- **要求**：所有业务逻辑必须放在core/
- **禁止**：前端目录中包含业务逻辑
- **示例**：
  ```python
  # ✅ 正确：所有前端都使用相同的服务
  from core.services import QuestionService
  
  # ❌ 错误：前端自己实现业务逻辑
  # 不要在web/、wechat/、mcp/中直接操作数据库
  ```

#### 数据模型共享 (`core/models.py`)
- **要求**：所有数据模型定义必须放在core/
- **禁止**：前端定义自己的数据模型
- **示例**：
  ```python
  # ✅ 正确：统一的数据模型
  from core.models import Question, Category, Tag
  
  # ❌ 错误：前端定义重复的模型
  # 不要在web/、wechat/、mcp/中定义Question类
  ```

#### 数据访问共享 (`core/database/`)
- **要求**：所有数据库操作必须通过core/database/
- **禁止**：前端直接连接数据库
- **示例**：
  ```python
  # ✅ 正确：使用共享的仓库
  from core.database.repositories import question_repo
  
  # ❌ 错误：前端直接执行SQL
  # 不要在web/、wechat/、mcp/中写SQL语句
  ```

### 3. 数据统一规则
#### 数据库文件
- **要求**：所有入口必须使用同一个数据库文件
- **路径**：`data/question_bank.db`（根目录）
- **禁止**：为不同入口创建不同的数据库

#### 数据一致性
- **要求**：任何入口的数据修改，其他入口必须立即可见
- **验证**：必须通过数据一致性测试
- **示例**：
  ```python
  # Web添加题目 → 微信立即能看到 → MCP也能搜索到
  ```

### 4. 接口清晰规则
#### 服务接口
- **要求**：core/必须提供清晰的服务接口
- **文档**：必须有完整的接口文档
- **示例**：
  ```python
  class QuestionService:
      """题目服务接口"""
      def add_question(data: QuestionCreate) -> Question:
          """添加题目"""
          pass
      
      def search_questions(keyword: str) -> List[Question]:
          """搜索题目"""
          pass
  ```

#### 错误处理
- **要求**：统一的错误类型和响应格式
- **示例**：
  ```python
  # 统一的错误响应
  {
      "success": False,
      "error": {
          "code": "VALIDATION_ERROR",
          "message": "题目内容不能为空"
      }
  }
  ```

### 5. 团队协作规则
#### 并行开发
- **要求**：三个团队可以同时开发不同入口
- **验证**：修改一个入口不影响其他入口
- **示例**：
  ```
  团队A修改web/ → 不影响wechat/和mcp/
  团队B修改wechat/ → 不影响web/和mcp/
  团队C修改mcp/ → 不影响web/和wechat/
  ```

#### 代码提交
- **要求**：每个入口的代码独立提交
- **禁止**：混合提交多个入口的修改
- **示例**：
  ```bash
  # ✅ 正确：分别提交
  git add web/ && git commit -m "Web: 添加批量导入功能"
  git add wechat/ && git commit -m "微信: 优化移动端API"
  git add mcp/ && git commit -m "MCP: 添加AI搜索工具"
  
  # ❌ 错误：混合提交
  git add web/ wechat/ mcp/ && git commit -m "修改了一些东西"
  ```

## 🔧 开发规则

### 代码质量
1. **预提交测试**：必须通过`scripts/pre_commit_test.sh`
2. **代码规范**：遵循PEP 8，使用类型提示
3. **注释要求**：关键函数必须有文档字符串
4. **错误处理**：必须有完善的错误处理

### 测试规则
1. **单元测试**：核心逻辑必须有单元测试
2. **集成测试**：前端与核心集成必须测试
3. **并发测试**：必须测试多入口并发访问
4. **数据测试**：必须测试数据一致性

### 部署规则
1. **独立部署**：每个入口可以独立部署
2. **共享依赖**：核心依赖必须一致
3. **配置管理**：使用`shared/config.py`统一配置
4. **环境隔离**：开发、测试、生产环境分离

## 📝 文档规则

### 必须有的文档
1. **架构文档**：`ARCHITECTURE_VALIDATION.md`（架构验证）
2. **用户指南**：`USER_GUIDE.md`（用户选择指南）
3. **API文档**：每个入口的API文档
4. **部署指南**：详细的部署步骤

### 文档质量
1. **实时更新**：代码修改必须更新文档
2. **示例完整**：必须有完整的代码示例
3. **问题排查**：必须有常见问题解决方案
4. **版本说明**：必须有版本变更说明

## 🚀 启动和测试规则

### 启动命令
```bash
# 启动Web入口
python start.py web

# 启动微信入口
python start.py wechat

# 启动MCP入口
python start.py mcp

# 初始化数据库
python start.py init

# 运行测试
python start.py test

# 查看状态
python start.py status
```

### 测试命令
```bash
# 运行预提交测试
./scripts/pre_commit_test.sh

# 运行数据库测试
python test_database.py <<< "2"

# 运行服务器测试
timeout 5 python test_server.py
```

## ✅ 验证规则

### 架构验证
每次提交前必须验证：
1. ✅ 前端目录独立
2. ✅ 核心代码共享
3. ✅ 数据访问统一
4. ✅ 接口定义清晰
5. ✅ 团队协作可行

### 功能验证
每次发布前必须验证：
1. ✅ 三个入口可以同时运行
2. ✅ 数据一致性保持
3. ✅ 并发访问无冲突
4. ✅ 错误处理完善
5. ✅ 性能满足要求

## 📊 规则执行

### 监督机制
1. **代码审查**：必须检查架构符合性
2. **自动化测试**：CI/CD流水线验证
3. **定期审计**：每月架构审计
4. **问题反馈**：建立问题反馈机制

### 违规处理
1. **警告**：首次违规给予警告
2. **修复要求**：必须限期修复
3. **代码回滚**：严重违规代码回滚
4. **规则培训**：违规团队需要重新培训

## 🎯 规则意义

### 为什么需要这些规则？
1. **保证质量**：确保系统稳定可靠
2. **提高效率**：团队并行开发，互不干扰
3. **降低维护**：架构清晰，易于维护
4. **支持扩展**：轻松添加新前端
5. **统一标准**：所有项目一致的标准

### 规则来源
这些规则基于：
1. **AGENTS.md全局规则**：多前端架构原则
2. **实际项目经验**：题库系统开发经验
3. **行业最佳实践**：企业级应用架构
4. **团队协作需求**：支持多团队并行开发

---
*最后更新：2026-02-24*
*版本：2.0（多前端架构版本）*
*依据：AGENTS.md全局规则 + 题库系统验证经验*